<html>
	<head>
		<title>Pig Latin Debugger</title>
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrap-responsive.min.css">
		<link rel="stylesheet" type="text/css" href="css/jquery-linedtextarea.css" />
		<link rel="stylesheet" type="text/css" href="style.css">
		<link rel="stylesheet" type="text/css" href="codemirror/doc/docs.css">
		<link rel="stylesheet" type="text/css" href="codemirror/lib/codemirror.css">
	</head>
	<body>
		<h1 id="title" style="color:purple;font-family:Helvetica;">Pig Latin Debugger</h1>
		<h4 id="date" style="color:0000CC;"></h4>
		<img id="pigicon" src="img/pig.jpeg" />
		<ul id="navtab" class="nav nav-pills">
		  	<li class="active"><a href="/">Pig</a></li>
			<li><a id="queryhistory_navbar" style="cursor: pointer;" onclick="setHistory(this)">Query History</a></li>
			<li><a id="terminal_navbar" style="cursor: pointer;" onclick="setPigTerminal(this)">Terminal</a></li>
			<li><a id="about_navbar" style="cursor: pointer;">About Author</a></li>
		</ul>
		<div id="pigbody">
			<div class="container well" id="scriptZone">
				<form id="searchform" class="form-search">
					<div class="input-prepend">
						<button type="submit" style="height:17%;width:13%;" class="btn" disabled="true"><i class="icon-search icon-white"></i></button><input id="search" type="text" class="search-query" placeholder="Search">
					</div>
				</form>
	   			<div id="turnpage">
	   				<ul class="pager">
					  	<li><button class="btn btn-primary" onclick="lastPage()"><i class="icon-arrow-left icon-white"></i></button></li>
					  	<span id="currentPage"></span>/<span id="totalPage"></span>
					  	<li><button class="btn btn-primary" onclick="nextPage()"><i class="icon-arrow-right icon-white"></i></button></li>
					</ul>
	       		</div>
	   			<table id="scriptFiles" class="table table-striped table-condensed">
	   				<thead><tr><td>#</td><td>scripts</td></tr></thead>
	   				<tbody id="scripttable"></tbody>
	   			</table>
	   		</div>

	   		<a style="cursor: pointer;" id="tip" data-toggle="tooltip" data-placement="bottom">Do you know?</a>
	   		<div id="parameter">
		   		<div id="helper" class="btn-group">
					<a class="btn btn-info dropdown-toggle" data-toggle="dropdown">
					    Pig Helper
					    <span class="caret"></span>
					</a>
					<ul id="pighelper" class="dropdown-menu">
					</ul>
				</div>

				<div id="mode" class="btn-group">
					<a id="ModeText" class="btn btn-warning dropdown-toggle" data-toggle="dropdown">
					    Mode
					    <span class="caret"></span>
					</a>
					<ul id="modeSelector" class="dropdown-menu">
						<li><a tabindex="-1" onclick="setMode(this.innerHTML)">local</a></li>
						<li><a tabindex="-1" onclick="setMode(this.innerHTML)">mapreduce</a></li>
					</ul>
				</div>
				<!--<div id="hadoopdirdiv">
					<input id="hadoopdir" type="text" placeholder="Hadoop Dir" />
				</div>-->
			</div>

			<div id="buttongroup1">
				<button class="btn btn-success" id="executeButton" onclick="executeScript()">Execute <i class="icon-play-circle icon-white"></i></button>
				<button class="btn btn-danger" id="killButton" onclick="killScript()">Kill <i class="icon-stop icon-white"></i></button>
				<button class="btn btn-info" id="explainButton" onclick="explainAlias()">Explain <i class="icon-info-sign icon-white"></i></button>
			</div>
			
			<div class="container well" id="input">
	   			<div id="scriptNameInputDiv">
					<input id="scriptNameInput" type="text" placeholder="Script name">
				</div>
	   			<button class="btn btn-success" id="createScriptButton" onclick="createScript()">New <i class="icon-plus-sign icon-white"></i></button>
	   			<button class="btn btn-primary" id="saveScriptButton" onclick="saveScript()">Save <i class="icon-hdd icon-white"></i></button>
	   			<button class="btn btn-danger" id="resetinputButton" onclick="resetScript()">Reset script <i class="icon-repeat icon-white"></i></button>
				<textarea id="scriptinputarea" style="word-break:break-all;"></textarea>
		   		<div id="progressBar" class="progress progress-striped active">
					<div id="progression" class="bar" style="width:0%;font-style:normal;font-size:100%;">0%</div>
				</div>
			</div>

			<div id="buttongroup2">
				<button class="btn btn-warning" id="downloadOutputButton" onclick="downloadOutput()">Download Output <i class="icon-download-alt icon-white"></i></button>
				<button class="btn btn-primary" id="downloadProgressLogButton" onclick="downloadProgressLog()">Download ProgressLog <i class="icon-download-alt icon-white"></i></button>
				<button class="btn btn-info" id="downloadExplainLogButton" onclick="downloadExplainLog()">Download ExplainLog <i class="icon-download-alt icon-white"></i></button>
				<button class="btn btn-warning" id="outputButton" onclick="openOutputLog()">Open Output <i class="icon-folder-open icon-white"></i></button>
				<button class="btn btn-primary" id="logButton" onclick="openStateLog()">Open ProgressLog <i class="icon-folder-open icon-white"></i></button>
				<button class="btn btn-info" id="explainLogButton" onclick="openExplainLog()">Open ExplainLog <i class="icon-folder-open icon-white"></i></button>
			</div>
			<span id="success" class="label label-default">State</span>
			
			<div id="logcontainer">
				
				<div class="container well" id="progressLog">
					<table id="progressLogTable" class="table table-striped table-condensed">
	       				<caption>
	       					<h5>Progress Log</h5>
	       					<br />
	       				</caption>
	       				<tbody id="stateLog"></tbody>
	       			</table>
				</div> 

				<div class="container well" id="result">
					<h5 id="outputlabel">Output</h5>
					<textarea id="resultarea" disabled="true"></textarea>
				</div>

				<div class="container well" id="explainlog">
					<h5 id="explainlabel">Explain Log</h5>
					<textarea id="explainarea" disabled="true"></textarea>
				</div>

				<div id="progressBarBackup" class="progress progress-striped active">
					  <div id="progressionBackup" class="bar" style="width:0%;font-style:normal;font-size:100%;">0%</div>
				</div>
			</div>
		</div>
		
        <script src="socket.io/socket.io.js"></script>
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	    <script src="js/bootstrap.min.js" type="text/javascript"></script>
	    <script src="js/viewport.js" type="text/javascript"></script>
	    <script src="js/jquery-linedtextarea.js" type="text/javascript"></script>
	    <script src="codemirror/lib/codemirror.js"></script>
		<script src="codemirror/mode/pig/pig.js"></script>
	    <script>
			
			var host = '146.169.44.198';
			var socket = io.connect('http://' + host + ':8080');
		    var string = '';
	        var output = '';

	        $(function(){
				$('#date').html((new Date()).toString().split(' ').splice(1,3).join('-'));

		        //When scroll window, if main progressBar is out of view, progressBarBackup shows up
				$(window).scroll(function() {
					if($("div#progressBar:in-viewport").length == 0){
				  		$('#progressBarBackup').slideDown();
				   }else{
				   		$('#progressBarBackup').slideUp();
				   }
				});

				showPigHelper();

				showToolTip();

				//Disable download output button and download progresslog button
				$('#downloadOutputButton').attr('disabled', true);
				$('#downloadProgressLogButton').attr('disabled', true);
				$('#outputButton').attr('disabled', false);
				$('#resetinputButton').attr('disabled', false);
				
			});

	        //script input editor

			var editor = CodeMirror.fromTextArea($('#scriptinputarea')[0], {
		        lineNumbers: true,
		        indentUnit: 4,
		        mode: "text/x-pig",
		        autofocus:true,
		    });
		    editor.on('keyup', function(cm, e) {
				var keywords = ['FOREACH', 'GENERATE', 'LIMIT', 'GROUP', 'STORE', 'TOKENIZE', 'EXPLAIN', 'ILLUSTRATE', 'DESCRIBE', 'IMPORT', 'CONCAT', 
							'COUNT', 'DISTINCT', 'FILTER', 'FLOOR', 'RANDOM', 'ROUND', 'TOTUPLE', 'TOBAG', 'TOMAP', 'INDEXOF', 'REPLACE', 'REGEX_EXTRACT',
							'LOWER', 'LAST_INDEX_OF', 'REGEX_EXTRACT_ALL', 'STRSPLIT', 'SUBSTRING', 'UCFIRST', 'UPPER', 'FLATTEN', 'CROSS', 'ORDER', 
							'SAMPLE', 'SPLIT', 'UNION', 'COGROUP', 'COUNT_START', 'PARALLEL'];

		    	var words = editor.getDoc().getValue().split(/[\s\W]+/);
	        	var lastword = words.pop();

	        	var last_word = words[words.length-1]
	        	//Press shift to autocomplete
				if(e.keyCode == 16){
					if(lastword.length >= 3){
	        			var pattern = new RegExp('^' + lastword.toUpperCase() + '.*');
	        			for(var i in keywords){
	        				if(pattern.test(keywords[i])){
	        					editor.getDoc().setValue(editor.getDoc().getValue().replace(new RegExp(lastword + '$'), keywords[i]));
	        					editor.setCursor(editor.lineCount(), 0);
	        					break;
	        				}
	        			}
	        		}
				}//Press space to transform small letter keyword to capital letter
				else if(e.keyCode == 32){
    				if(keywords.indexOf(last_word.toUpperCase()) >= 0){
    					editor.getDoc().setValue(editor.getDoc().getValue().replace(last_word, last_word.toUpperCase()));
    					editor.setCursor(editor.lineCount(), 0);
    				}
        		}
			});

	        function showPigHelper(){
				var pighelper = {
		        	'Eval Fucntions': [ 
		        		'AVG(%VAR%)', 'CONCAT(%VAR%)', 'COUNT(%VAR%)', 'COUNT_START(%VAR%)', 'IsEmpty(%VAR%)', 'DIFF(%VAR1%, %VAR2%)', 'MAX(%VAR%)', 
		        		'MIN(%VAR%)', 'SIZE(%VAR%)', 'SUM(%VAR%)', 'TOKENIZE(%VAR%, %DELIMITER%)'],

		        	'Relational Operators':[
		        		'COGROUP %VAR% BY %VAR%', 'CROSS %VAR1%, %VAR2%', 'DISTINCT %VAR%', 'FILTER %VAR% BY %CONDITION%', 'FLATTEN(%VAR%)',
		        		'FOREACH %DATA% GENERATE %NEW_DATA%', 'FOREACH %DATA% {%NESTED_BLOCK%}', 'GROUP %VAR% BY %VAR%', 'GROUP %VAR% ALL', 'JOIN %VAR% BY', 
		        		'LIMIT %VAR% %N%', 'ORDER %VAR% BY %FIELD%', 'SAMPLE %VAR% %SIZE%', 'SPLIT %VAR1% INTO %VAR2% IF %EXPRESSION%', 
		        		'UNION %VAR1%, %VAR2%', 'PARALLEL %NUM%'],

		        	'I/O':[
		        		'LOAD \'%FILE%\'', 'DUMP %VAR%', 'STORE %VAR% INTO %PATH%'],

		        	'Debug':[
		        		'EXPLAIN %VAR%', 'ILLUSTRATE %VAR%', 'DESCRIBE %VAR%'],

		        	'Math': [			
		        		'ABS(%VAR%)', 'ACOS(%VAR%)', 'ASIN(%VAR%)', 'ATAN(%VAR%)', 'CBRT(%VAR%)', 'CEIL(%VAR%)', 'COS(%VAR%)', 'COSH(%VAR%)', 'EXP(%VAR%)',
		        		'FLOOR(%VAR%)', 'LOG(%VAR%)', 'LOG10(%VAR%)', 'RANDOM(%VAR%)', 'ROUND(%VAR%)', 'SIN(%VAR%)', 'SINH(%VAR%)', 'TAN(%VAR%)', 
		        		'TANH(%VAR%)'],

		        	'Tuple,Bag,Map Functions':[
		        		'TOTUPLE(%VAR%)', 'TOBAG(%VAR%)', 'TOMAP(%KEY%, %VALUE%)', 'TOP(%topN%, %COLUMN%, %RELATION%)'],

		        	'String Functions':[
		        		'INDEXOF(%STRING%, \'CHARACTER\', %START_INDEX%)', 'LAST_INDEX_OF(%STRING%, \'CHARACTER\', %START_INDEX%)', 'LOWER(%STRING%)',
		        		'REGEX_EXTRACT(%STRING%, %REGEX%, %INDEX%)', 'REGEX_EXTRACT_ALL(%STRING%, %REGEX%)', 'REPLACE(%STRING%, %OLD_CHAR%, %NEW_CHAR%)',
		        		'STRSPLIT(%STRING%, %REGEX%, %LIMIT%)', 'SUBSTRING(%STRING%, %START_INDEX%, %END_INDEX%)', 'TRIM(%STRING%)', 'UCFIRST(%STRING%)',
		        		'UPPER(%STRING%)'],

		        	'Macro':[
		        		'IMPORT \'PATH_TO_MACRO\'']
				};

				var res = '';
				for(var i in pighelper){
					res += '<li class="dropdown-submenu">';
					res += '<a tabindex="-1" href="#">' + i + '</a><ul class="dropdown-menu">';
					for(var j in pighelper[i]){
						res += '<li><a tabindex="-1" href="#" onclick="selectHelperFunction(this.innerHTML)">' + pighelper[i][j] + '</a></li>'
					}
					res += '</ul></li>';
				}
			
				$('#pighelper').html(res);
			}

			function showToolTip(){
				var tip_array = {
					'#helper' : 'Pig Helper helps you find the needed Pig Operators!',
					'#tip' : 'Type at least 3 letters and press shift to enable autocompletion!',
					'#mode' : 'Choose local/mapreduce mode',
					'#createScriptButton' : 'New Button enables to create a new Pig script!',
					'#saveScriptButton' : 'Save Button enables to save an existed Pig script!',
					'#resetinputButton' : 'Reset Button enables to empty the Pig text area below!',
					'#downloadOutputButton' : 'Download Output Button enables you to download the output not until the Pig script execution is finished!',
					'#downloadProgressLog' : 'Download ProgressLog Button enables to downlaod the progress log not until the Pig script execution is finished!',
					'#queryhistory_navbar' : 'Query History helps you visualize the previous Pig script information!',
					'#terminal_navbar' : 'Terminal helps you interact with console!',
					'#about_navbar' : 'Nan Wang -- Imperial College London -- 2014',
					'#executeButton' : 'Execute Button enables you to launch the execution of the Pig script!',
					'#killButton' : 'Kill Button enables you to stop the execution of the running Pig script!',
					'#explainButton' : 'Explain Button provide information on how a pig query will be executed!',
					'#logButton' : 'This Button enables you to show/hide the progress log area!',
					'#outputButton' : 'Open Output Button enables you to show/hide the output area!',
					'#searchform' : 'Search widget helps you find the specific pig script!',
					'#progressBar' : 'Progress bar!'
				}

				for(var i in tip_array){
					$(i).attr('title', tip_array[i]);
					if(i == '#queryhistory_navbar' || i == '#terminal_navbar' || i == '#about_navbar'){
						$(i).attr('data-placement', 'bottom');
					}
					$(i).tooltip();
				}
			}

			function selectHelperFunction(value){
				editor.getDoc().setValue(editor.getDoc().getValue() + value);
				editor.setCursor(editor.lineCount(), 0);
			}

			$('#search').keyup(function(){
	        	var scriptsFound = [];
	        	var pattern = new RegExp('^' + $(this).val()+'.*');
	        	for(var i in scripts){
					if(pattern.test(scripts[i])){
	        			scriptsFound.push(scripts[i]);
	        		}
	        	}
	        	if(scriptsFound.length == 0){
	        		$('#scripttable').html("No scripts found!");
	        		currentPageNumber = 0;
	        		$('#currentPage').html(currentPageNumber);
	        		totalPageNumber = 0;
	        		$('#totalPage').html(totalPageNumber);

	        	}else{
	        		filterScripts(scriptsFound);
	        	}
	        });

			var mapreduceprogressRecord = [];
			var currentJobId;
			var jobsNumber;
			var jobsCount = 0;
			var currentScriptUUID;
			var mode;
			var kill = false;
			var alias = {};
			var highlight = [];
			function coordinate(data){
		        if(data.notification == 'fail'){
	        		$('#success').attr('class','label label-important');
					$('#success').html('Fail');
					$('#progressBar').attr('class','progress progress-danger progress-striped active');
					$('#progressBarBackup').attr('class','progress progress-danger progress-striped active');
					$('#progression').css('width','100%');
					$('#progressionBackup').css('width','100%');
					$('#progression').html('');
					$('#progressionBackup').html('');
					string += '<tr>';
			        string += '<td>' + data.error + '</td>';
			        string += '</tr>';
					$('#stateLog').html(string);

	        	} else if(data.notification == 'progress'){
	        		if(parseInt(data.progress) != 100){
	        			$('#progression').css('width',parseInt(data.progress)+'%');
	        			$('#progression').html(parseInt(data.progress)+'%');
	        			$('#progressionBackup').css('width',parseInt(data.progress)+'%');
						$('#progressionBackup').html(parseInt(data.progress)+'%');
	        		}else{
						$('#progression').css('width','99%');
						$('#progressionBackup').css('width','99%');
						$('#progression').html('99%');
						$('#progressionBackup').html('99%');
					}
				} else if(data.notification == 'output'){
					transformOutput(data.result);
				} else if(data.notification == 'success'){
					$('#success').attr('class','label label-success');
					$('#success').html('Succeed');
					$('#progression').css('width','100%');
					$('#progressionBackup').css('width','100%');
					$('#progression').html('100%');
					$('#progressionBackup').html('100%');
					string += '<tr>';
			        string += '<td>Total duration: ' + parseFloat(data.duration/1000) + ' seconds' + '</td>';
			        if(mode == 'mapreduce'){
			        	string += '<td></td><td></td>';
			        }
			        string += '</tr>';
			        $('#stateLog').html(string);
					$('#resultarea').html(output);
					$('#downloadOutputButton').prop("disabled", false);
					$('#downloadProgressLogButton').prop("disabled", false);
					$('#logcontainer').css('height','50%');

				}else if(data.notification == 'mapreduceprogress'){
					if(parseInt(data.mapprogress) == 1 && parseInt(data.reduceprogress) == 0){
						$('#map_'+data.jobid).css('width', parseInt(data.mapprogress)*100 + '%');
						$('#map_'+data.jobid).html('Map '+parseInt(data.mapprogress)*100+'%');
						
						var delay = 1000;
					    setTimeout(function(){
					    	$('#map_'+data.jobid).css('width', parseInt(data.mapprogress)*100 + '%');
							$('#map_'+data.jobid).html('Map '+parseInt(data.mapprogress)*100+'%');
					        $('#reduce_'+data.jobid).css('width', '25%');
					        $('#reduce_'+data.jobid).html('Reduce 25%');
					    }, delay); 
					}else if(parseInt(data.mapprogress) == 1 && parseInt(data.reduceprogress) == 1){
						$('#map_'+data.jobid).css('width', parseInt(data.mapprogress)*100 + '%');
						$('#reduce_'+data.jobid).css('width', '90%');
						$('#map_'+data.jobid).html('Map '+parseInt(data.mapprogress)*100+'%');
						$('#reduce_'+data.jobid).html('Reduce 90%');
						if(mapreduceprogressRecord.indexOf(data.jobid) < 0){
							mapreduceprogressRecord.push(data.jobid);
						}
					}
				}else if(data.notification == 'jobstart'){
					
					for(var i in highlight){
						$( "div.CodeMirror-code").children().eq(highlight[i]).css("background-color", "white");
					}
					highlight = [];
					var singleAlias = alias[jobsCount];
					for(var i in singleAlias){
						highlight.push(line_clause[singleAlias[i]]);
					}
					for(var i in highlight){
						$( "div.CodeMirror-code").children().eq(highlight[i]).css("background-color", "yellow");
					}

					jobsCount += 1;
					currentJobId = data.jobid;

					string += '<tr>';
			        string += '<td>' + data.operation + '</td>';
			        if(data.mode == 'mapreduce'){
			        	string += '<td style="width:22%;"><div class="progress progress-info progress-striped active"><div id="map_' + data.jobid + '" class="bar" style="width:0%;font-style:normal;font-size:100%;">Map 0%</div></div></td><td style="width:22%;"><div class="progress progress-warning progress-striped active"><div id="reduce_' + data.jobid + '" class="bar" style="width:0%;font-style:normal;font-size:100%;">Reduce 0%</div></div></td>';
			        }
			        string += '</tr>';
			        $('#stateLog').html(string);

			        if(data.mode == 'mapreduce'){
			        	var delay = 1000;
					    setTimeout(function(){
					        $('#map_'+data.jobid).css('width', '25%');
					        $('#map_'+data.jobid).html('Map 25%');
					        //$('#stateLog').html(string);
					        for(var i in mapreduceprogressRecord){
								$('#map_' + mapreduceprogressRecord[i]).css('width', '100%');
								$('#reduce_' + mapreduceprogressRecord[i]).css('width', '100%');
								$('#map_' + mapreduceprogressRecord[i]).html('Map 100%');
								$('#reduce_' + mapreduceprogressRecord[i]).html('Reduce 100%');
							}
					    }, delay); 
			        }
					
				}else if(data.notification == 'jobfinish'){
					if(data.mode == 'mapreduce'){
						if($('#reduce_'+data.jobid).css('width') != '100%'){
							$('#reduce_'+data.jobid).css('width','100%');
							$('#reduce_'+data.jobid).html('Reduce 100%');
						}
						if(mapreduceprogressRecord.indexOf(data.jobid) < 0){
							mapreduceprogressRecord.push(data.jobid);
						}
					}
					
					//if it is the last job, remove delay function
					if(jobsCount == jobsNumber){
						string += '<tr>';
				        string += '<td>' + data.operation + '</td>';
				        if(data.mode == 'mapreduce'){
				        	string += '<td style="text-align:center;">' + data.mapNumber + ' maps : ' + parseFloat(data.maptime/1000)  + ' s</td><td style="text-align:center;">' + data.reduceNumber + ' reduces : ' + parseFloat(data.reducetime/1000) + ' s</td>';
				        }
				        
				        string += '</tr>';
				        $('#stateLog').html(string);
				        if(data.mode == 'mapreduce') {
				        	 for(var i in mapreduceprogressRecord){
								$('#map_' + mapreduceprogressRecord[i]).css('width', '100%');
								$('#reduce_' + mapreduceprogressRecord[i]).css('width', '100%');
								$('#map_' + mapreduceprogressRecord[i]).html('Map 100%');
								$('#reduce_' + mapreduceprogressRecord[i]).html('Reduce 100%');
							}
				        }
				    }else{
						var delay = 500;
					    setTimeout(function(){
							string += '<tr>';
					        string += '<td>' + data.operation + '</td>';
					        if(data.mode == 'mapreduce'){
					        	string += '<td style="text-align:center;">' + data.mapNumber + ' maps : ' + parseFloat(data.maptime/1000)  + ' s</td><td style="text-align:center;">' + data.reduceNumber + ' reduces : ' + parseFloat(data.reducetime/1000) + ' s</td>';
					        }

					        string += '</tr>';
					        $('#stateLog').html(string);
					        for(var i in mapreduceprogressRecord){
								$('#map_' + mapreduceprogressRecord[i]).css('width', '100%');
								$('#reduce_' + mapreduceprogressRecord[i]).css('width', '100%');
								$('#map_' + mapreduceprogressRecord[i]).html('Map 100%');
								$('#reduce_' + mapreduceprogressRecord[i]).html('Reduce 100%');
							}
					    }, delay); 
					}
				}else if(data.notification == 'start'){
					currentScriptUUID = data.uuid;
					
					jobsNumber = parseInt(data.jobsNumber);
					string += '<tr>';
			        string += '<td>' + data.operation + '</td>';
			        if(data.mode == 'mapreduce'){
			        	string += '<td></td><td></td>';
			        }
			        
			        string += '</tr>';
			        $('#stateLog').html(string);
				}else if(data.notification == 'launch'){
					var aliasArray = data.alias.split('+');
					for(var i in aliasArray){
						alias[i] = aliasArray[i].split(',');
					}

					string += '<tr>';
			        string += '<td>' + data.operation + '</td>';
			        mode = data.mode;

			        if(data.mode == 'mapreduce'){
			        	string += '<td></td><td></td>';
			        }
			       
			        string += '</tr>';
			        $('#stateLog').html(string);
				}else if(data.notification == 'explain'){
					$('#explainarea').html(data.plan);
				}else{
					string += '<tr>';
			        string += '<td>' + data.operation + '</td>';
			        if(mode == 'mapreduce'){
			        	string += '<td></td><td></td>';
			        }
			       
			        string += '</tr>';
			        $('#stateLog').html(string);
				}
				
				if(mode == 'mapreduce'){
					for(var i in mapreduceprogressRecord){
						$('#map_' + mapreduceprogressRecord[i]).css('width', '100%');
						$('#reduce_' + mapreduceprogressRecord[i]).css('width', '100%');
						$('#map_' + mapreduceprogressRecord[i]).html('Map 100%');
						$('#reduce_' + mapreduceprogressRecord[i]).html('Reduce 100%');
					}
				}
			}

			//Get data from server
	        socket.on('notification', function (data) {
	        	if(type == 'script'){
	        		var notifications = data.split('\n');
		        	for(var i in notifications){
		        	 	if(i != notifications.length - 1){
		        	 		var tcpData = JSON.parse(notifications[i]);
		        	 		if(!kill){
		        	 			coordinate(tcpData);
		        	 		}
		        	 	}
		        	}
	        	}else if(type == 'explain'){
	        		var tcpData = JSON.parse(data);
	        		coordinate(tcpData);
	        	}
			});

	        var totalPageNumber;
	        var scripts;
	        var itemNumber = 11;
	        //Get script names
		   	socket.on('scriptNames', function(data) {
		   		scripts = data;
		   		totalPageNumber = Math.ceil(data.length / itemNumber);
		   		if(currentPageNumber > totalPageNumber){
		   			currentPageNumber = 1;
		   		}
		   		$('#totalPage').html(totalPageNumber);
		   		$('#currentPage').html(currentPageNumber);
		   		showScripts();
		   	});

		   	//Get script content
		   	socket.on('scriptContent', function(data){
		   		editor.getDoc().setValue(data);
		   	});

		   	function transformOutput(data)
		   	{
		   		var list = data.split('-');
		   		for(var i=0;i<list.length;i++){
		   			list[i] = list[i].toString().replace("null","");
		   			list[i] = list[i].toString().replace("[","(");
		   			list[i] = list[i].toString().replace("]",")");
		   			output += list[i] + '\n';
		   		}
		   	}

		   	var currentPageNumber = 1;
		   	//show scripts table
		   	function showScripts()
		   	{
		   		var res = '';
		   		count = (currentPageNumber-1)*itemNumber + 1;
		   		var min;
		   		if(currentPageNumber==totalPageNumber && scripts.length%itemNumber!=0){
		   			min = scripts.length - 1;
		   		}else{
		   			min = currentPageNumber*itemNumber-1;
		   		}

		   		for(var i=(currentPageNumber-1)*itemNumber;i<=min;i++)
		   		{
		   			res += '<tr style="height:5%;">';
		   			res += '<td class="span1">' + count + '</td>';
					res += '<td class="span4" style="word-break:break-all;">' + scripts[i] + '</td>';
					res += '<td><button name="' + scripts[i] + '" class="btn btn-danger" onclick="deleteScript(this.name)"><i class="icon-trash icon-white"</i></button></td>';
					res += '<td><button name="' + scripts[i] + '" id="' + scripts[i].substring(0, scripts[i].length-4) + '" class="btn btn-warning" onclick="selectScript(this.id)"><i class="icon-file icon-white"</i></button></td>';
		   			res += '</tr>';
		   			count++;
				}
				
		   		$('#scripttable').html(res);
		   		$('#'+selectedScript).attr('class','btn btn-success');
				$('#'+selectedScript).html('<i class="icon-ok-circle icon-white"></i>');
		   	}

		   	//show script when search is launched
		   	function filterScripts(data)
		   	{
		   		currentPageNumber = 1;
		   		totalPageNumber = Math.ceil(data.length / itemNumber);
		   		$('#currentPage').html(currentPageNumber);
		   		$('#totalPage').html(totalPageNumber);

		   		var res = '';
		   		count = (currentPageNumber-1)*itemNumber + 1;
		   		var min;
		   		if(currentPageNumber==totalPageNumber && data.length%itemNumber!=0){
		   			min = data.length - 1;
		   		}else{
		   			min = currentPageNumber*itemNumber-1;
		   		}
		   		
		   		for(var i=(currentPageNumber-1)*itemNumber;i<=min;i++)
		   		{
		   			res += '<tr style="height:5%;">';
		   			res += '<td class="span1">' + count + '</td>';
					res += '<td class="span8" style="word-break:break-all;">' + data[i] + '</td>';
					res += '<td><button name="' + data[i] + '" class="btn btn-danger" onclick="deleteScript(this.name)"><i class="icon-trash icon-white"</i></button></td>';
					res += '<td><button name="' + data[i] + '" id="' + data[i].substring(0, data[i].length-4) + '" class="btn btn-warning" onclick="selectScript(this.id)"><i class="icon-file icon-white"</i></button></td>';
		   			res += '</tr>';
		   			count++;
				}
				
		   		$('#scripttable').html(res);
		   	}
			
			//save script
	    	function createScript(){
	    		var file = $('#scriptNameInput').val() + '.pig';
	    		if(file.trim() == '.pig'){
	    			$('#scriptNameInputDiv').addClass('control-group error');
	    			alert('Script name is required!');
				}else{
					selectedScript = $('#scriptNameInput').val();
					$('#scriptNameInputDiv').removeClass('control-group error');
	    			var content = editor.getDoc().getValue();
					var data = {'content':content,
		    					'file':file};
		    		socket.emit('saveFile', data);
		    		alert('The file is created successfully!');
	    		}
	    	}

			function saveScript(){
				if(selectedScript.trim() == ''){
					alert('No script is selected!');
				}else{
					var content = editor.getDoc().getValue();
					var data = {'content':content,
		    					'file':selectedScript + '.pig'};
		    		socket.emit('saveFile', data);
		    		alert('The file is saved successfully!');
		    	}
			}

			//delete script
			function deleteScript(name){
				if(confirm("Do you want to delete this script?")){
					socket.emit('deleteFile', name);
				}
			}

			//select file
			var selectedScript = '';
			function selectScript(name){
				reset();
				kill = false;

				$('#ModeText').html('Mode <span class="caret"></span>');

				if(selectedScript != ''){
					$('#'+selectedScript).attr('class','btn btn-warning');
					$('#'+selectedScript).html('<i class="icon-file icon-white"></i>');
				}
				
				$('#'+name).attr('class','btn btn-success');
				$('#'+name).html('<i class="icon-ok-circle icon-white"></i>');
				socket.emit('selectFile', name);
				selectedScript = name;
			}

			//execute script
			var line_clause = {};
			var type;
			function executeScript(){
				type = 'script';
				reset();
				kill = false;

				//get the line number mapping to alias
				var content = editor.getDoc().getValue();
				var clauses = content.split(';');
				for(var i in clauses){
					var alias = clauses[i].split('=');
				}

				var lines = content.split('\n');
				for(var i in lines){
					if(lines[i].indexOf('=') > 0){
						line_clause['' + lines[i].split('=')[0].trim()+''] = i;
					}
				}

				var mode = $('#ModeText').text().trim();
				if(selectedScript == ''){
					alert('No script selected!');
				}else if(mode == 'Mode'){
					alert('No mode selected!');
				}else{
					var data = {'name': selectedScript,
								'mode': mode
						   	   };
					
					socket.emit('execute', data);
				}
			}

			//kill script
			function killScript(){
				kill = true;
				socket.emit('kill', 'kill');
				reset();
			}

			//explain the specific alias
			function explainAlias(){
				type = 'explain';
				var mode = $('#ModeText').text().trim();
				if(selectedScript == ''){
					alert('No script selected!');
				}else if(mode == 'Mode'){
					alert('No mode selected!');
				}else{
					var data = {'name': selectedScript,
								'mode': mode
						   	   };
					
					socket.emit('explain', data);
				}
			}

			function reset(){
				$('#progression').css('width','0%');
				$('#progressionBackup').css('width','0%');
				$('#progressBar').attr('class','progress progress-success progress-striped active');
				$('#progressBarBackup').attr('class','progress progress-success progress-striped active');
				$('#progression').html('');
				$('#progressionBackup').html('');
				$('#stateLog').html('');
				$('#success').html('State');
				$('#success').attr('class','label label-default');
				$('#resultarea').html('');
				output = '';
				string = '';
				mapreduceprogressRecord = [];
			}

			//open state log
			function openStateLog(){
				$('#progressLog').slideToggle();
				if($('#logButton').text().trim() == 'Open ProgressLog'){
					$('#logButton').html('Close ProgressLog <i class="icon-folder-close icon-white"></i>');
				} else{
					$('#logButton').html('Open ProgressLog <i class="icon-folder-open icon-white"></i>');
				}
			}

			//Open output log
			function openOutputLog(){
				$('#result').slideToggle();
				if($('#outputButton').text().trim() == 'Open Output'){
					$('#outputButton').html('Close Output <i class="icon-folder-close icon-white"></i>');
				} else{
					$('#outputButton').html('Open Output <i class="icon-folder-open icon-white"></i>');
				}
			}

			//Open explain log
			function openExplainLog(){
				$('#explainlog').slideToggle();
				if($('#explainLogButton').text().trim() == 'Open ExplainLog'){
					$('#explainLogButton').html('Close ExplainLog <i class="icon-folder-close icon-white"></i>');
				} else{
					$('#explainLogButton').html('Open ExplainLog <i class="icon-folder-open icon-white"></i>');
				}
			}

			function selectMode(value){
				$('#modebutton').html(value);
			}

			function downloadOutput(){
				var download = {
					result : $('#resultarea').html(),
					uuid : currentScriptUUID
				}

				socket.emit('downloadOutput', download);
				var win = window.open("download.html", '_blank');
  				//win.focus();
			}

			function downloadProgressLog(){

			}

			function nextPage(){
				if(currentPageNumber != totalPageNumber){
					currentPageNumber += 1;
					$('#currentPage').html(currentPageNumber);
					showScripts();
				}
				else alert("Last page!");
			}

			function lastPage(){
				if(currentPageNumber!=1 && currentPageNumber !=0){
					currentPageNumber -= 1;
					$('#currentPage').html(currentPageNumber);
					showScripts();
				}
				else alert("First page!");
			}

			function resetScript(){
				editor.getDoc().setValue('');
			}

			function helper(value){
				$('#scriptinputarea').val(value);
			}
			
			function setPigTerminal(node){
				$('#navtab').children().removeClass('active');
				$(node).parent().addClass('active');
				$('#pigbody').html('<iframe src="http://' + host + ':4200"></iframe><div id="terminalfoot">Author : Nan Wang - Imperial College London</div><br />');
			}

			//Query History
			socket.on('result', function(data){
				showHistory(data);
			});

			var historycurrentPage = 1;
			var historytotalPage = 1;
			var historynumberPerPage = 12;
			function historyLastPage(){
				if(historycurrentPage == 1 || historycurrentPage == 0){
					alert('First page!')
				}else{
					historycurrentPage -= 1;
					socket.emit('historycurrentPage', historycurrentPage);
				}
			}

			function historyNextPage(){
				if(historycurrentPage == historytotalPage){
					alert('Last page!')
				}else{
					historycurrentPage += 1;
					socket.emit('historycurrentPage', historycurrentPage);
				}
			}

			function showHistory(data){
				historytotalPage = Math.ceil(parseInt(data.number[0].number) / historynumberPerPage);
				var data = data.items;
				
				var res = '';
				res += '<div class="container well" id="history">';
				res += '<div id="historypager"><button class="btn btn-primary" onclick="historyLastPage()"><i class="icon-arrow-left icon-white"></i></button>';
				res += '<span id="historycurrentPage"></span>/<span id="historytotalPage"></span>';
				res += '<button class="btn btn-primary" onclick="historyNextPage()"><i class="icon-arrow-right icon-white"></i></button></div>';
				res += '<div><table class="table table-striped table-condensed">';
				res += '<thead><tr><td style="text-align:center;">#</td><td style="text-align:center;">Name</td><td style="text-align:center;">UUID</td><td style="text-align:center;">Time</td><td style="text-align:center;">State</td><td style="text-align:center;">Output</td><td style="text-align:center;">ProgressLog</td><td style="text-align:center;">ExplainLog</td></tr></thead><tbody>';
				for(var i in data){
					res += '<tr style="height:4%;">';
					res += '<td style="text-align:center;width:8%;">' + data[i].id + '</td>';
					res += '<td style="text-align:center;word-break:break-all;width:12%;">' + data[i].name + '</td>';

					res += '<td style="text-align:center;width:25%;">' + data[i].script_uuid + '</td>';
					res += '<td style="text-align:center;width:15%;">' + data[i].time + '</td>';
					if(data[i].state == 'Fail'){
						res += '<td style="text-align:center;"><span class="label label-important" style="height:65%;padding-top:7%;font-size:12pt;">' + data[i].state + '</span></td>';
						res += '<td style="text-align:center;"><button class="btn btn-danger">ErrorLog<i class="icon-download-alt icon-white"></i></button></td>';
						res += '<td style="text-align:center;width:11%;"><button class="btn btn-warning" disabled>ProgressLog <i class="icon-download-alt icon-white"></i></button></td>';
						res += '<td style="text-align:center;width:11%;"><button class="btn btn-info" disabled>ExplainLog <i class="icon-download-alt icon-white"></i></button></td></tr>'
					}else{
						res += '<td style="text-align:center;width:8%;"><span class="label label-success" style="height:65%;padding-top:7%;font-size:12pt;text-align:center;">' + data[i].state + '</span></td>';
						res += '<td style="text-align:center;width:10%;"><button class="btn btn-primary" name="' + data[i].script_uuid + '" onclick="downloadHistoryOutput(this.name)">Output <i class="icon-download-alt icon-white"></i></button></td>';
						res += '<td style="text-align:center;width:11%;"><button class="btn btn-warning">ProgressLog <i class="icon-download-alt icon-white"></i></button></td>';
						res += '<td style="text-align:center;width:11%;"><button class="btn btn-info">ExplainLog <i class="icon-download-alt icon-white"></i></button></td></tr>'
					}
				}
				res += '</tbody></table></div></div>';
				res += '<div id="terminalfoot">Author : Nan Wang - Imperial College London</div><br />'
				$('#pigbody').html(res);
				if(historytotalPage == 0){
					historycurrentPage = 0;
				}
				$('#historycurrentPage').html(historycurrentPage);
				$('#historytotalPage').html(historytotalPage);
			}

			socket.on('outputDone', function(data){
				var win = window.open("download.html", '_blank');
				win.focus();
			});

			function downloadHistoryOutput(uuid){
				socket.emit('downloadHistoryOutput', uuid);
			}

			function setHistory(node){
				$('#navtab').children().removeClass('active');
				$(node).parent().addClass('active');
				socket.emit('historycurrentPage', 1);
			}

			function setMode(mode){
				$('#ModeText').html(mode + ' <span class="caret"></span>');
			}

		</script>
    </body>
</html>
